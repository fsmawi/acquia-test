# Don't show directory listings for URLs which map to a directory.
Options -Indexes

# Follow symbolic links in this directory.
Options +FollowSymLinks

# Set the default handler. We're using index.php so it can require HTTP
# Authorization.  Cloud does not support AuthUserFile because it requires
# an absolute path which is not available.
DirectoryIndex index.php
# When we no longer need HTTP Authorization, use this instead.
# DirectoryIndex index.html

<IfModule mod_rewrite.c>
  RewriteEngine on

  # Force HTTPs
  RewriteCond %{HTTPS} off
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R,L]

  # Catch mock api endpoint requests
  RewriteRule ^mock/api/(.*)$ server/api/mock.php?q=$1 [QSA,NC]

  # Block access to "hidden" directories whose names begin with a period.
  RewriteRule "(^|/)\." - [F]

  # Rewrite /path to /#/path via external redirect.
  #
  # Do not rewrite anything that refers to a valid path in the filesystem.
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  # Do not rewrite css, js and images (even if they don't exist?
  # not sure why, but I saw this in an Angular example...)
  RewriteCond %{REQUEST_URI} !\.(?:css|js|map|jpe?g|gif|png)$ [NC]
  # Avoid loops.
  RewriteCond %{REQUEST_URI} !\#
  # Rewrite everything else via external redirect, and without escaping #.
  # Force SSL, since on Acquia Cloud, SSL is terminated on the balancers and
  # Apache thinks the request was over HTTP.
  RewriteRule ^(.*)$ https://%{HTTP_HOST}/\#/$1 [R,L,NE]

  # Rules to correctly serve gzip compressed CSS and JS files.
  # Requires both mod_rewrite and mod_headers to be enabled.
  <IfModule mod_headers.c>
    # Serve gzip compressed CSS files if they exist and the client accepts gzip.
    RewriteCond %{HTTP:Accept-encoding} gzip
    RewriteCond %{REQUEST_FILENAME}\.gz -s
    RewriteRule ^(.*)\.css $1\.css\.gz [QSA]

    # Serve gzip compressed JS files if they exist and the client accepts gzip.
    RewriteCond %{HTTP:Accept-encoding} gzip
    RewriteCond %{REQUEST_FILENAME}\.gz -s
    RewriteRule ^(.*)\.js $1\.js\.gz [QSA]

    # Serve correct content types, and prevent mod_deflate double gzip.
    RewriteRule \.css\.gz$ - [T=text/css,E=no-gzip:1]
    RewriteRule \.js\.gz$ - [T=text/javascript,E=no-gzip:1]

    <FilesMatch "(\.js\.gz|\.css\.gz)$">
      # Serve correct encoding type.
      Header set Content-Encoding gzip
      # Force proxies to cache gzipped & non-gzipped css/js files separately.
      Header append Vary Accept-Encoding
    </FilesMatch>
  </IfModule>
</IfModule>

<IfModule mod_expires.c>
  # Enable expirations.
  ExpiresActive On

  # Cache all files for 2 weeks after access (A).
  # ExpiresDefault A1209600
  # For now, no caching.
  ExpiresDefault A0

  <FilesMatch \.php$>
    # Never cache PHP scripts.
    ExpiresActive Off
  </FilesMatch>
</IfModule>
